<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Fiscalização de Rodovias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
        }
        
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .app-title {
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .nav-tabs .nav-link {
            font-weight: 500;
            color: var(--secondary-color);
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #dee2e6;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: transparent;
            border-color: var(--primary-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .required-field::after {
            content: " *";
            color: var(--danger-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-contractor {
            background-color: var(--secondary-color);
            color: white;
            font-size: 0.8rem;
        }
        
        .geo-badge {
            font-size: 0.8rem;
        }
        
        .inspector-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        
        .multiple-contractors {
            color: #d63384;
            font-weight: bold;
        }
        
        .control-item {
            padding: 12px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .control-item:hover {
            background-color: #e9ecef;
        }
        
        .priority-high {
            border-left: 4px solid var(--danger-color);
        }
        
        .priority-medium {
            border-left: 4px solid var(--warning-color);
        }
        
        .priority-low {
            border-left: 4px solid var(--success-color);
        }
        
        .days-left {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }
        
        .days-overdue {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .excel-upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .excel-upload-area:hover {
            background-color: #e9ecef;
            border-color: #0b5ed7;
        }
        
        .excel-upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .multiple-inspections-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        
        .inspection-item {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            position: relative;
            border-radius: 5px;
            background-color: white;
            margin-bottom: 10px;
        }
        
        .inspection-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .remove-inspection {
            position: absolute;
            right: 10px;
            top: 10px;
        }
        
        /* Responsividade */
        @media (max-width: 992px) {
            .container {
                padding: 0 15px;
            }
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
            }
            
            .nav-item {
                flex: 0 0 auto;
            }
            
            .tab-content > .tab-pane {
                padding: 10px;
            }
            
            .btn {
                margin-bottom: 8px;
            }
            
            .inspector-photo {
                width: 40px;
                height: 40px;
            }
        }
        
        @media (max-width: 576px) {
            .row {
                flex-direction: column;
            }
            
            .col-md-6, .col-md-4, .col-md-3 {
                width: 100%;
                margin-bottom: 15px;
            }
            
            .btn {
                width: 100%;
            }
            
            .control-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .days-left {
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container app-container">
        <header class="app-header">
            <h1 class="app-title">Sistema de Fiscalização de Rodovias</h1>
            <p class="text-muted">Controle completo de vistorias e manutenção de rodovias</p>
        </header>
        
        <ul class="nav nav-tabs" id="appTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">
                    <i class="fas fa-clipboard-check me-2"></i>Registrar Vistoria
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="roads-tab" data-bs-toggle="tab" data-bs-target="#roads" type="button" role="tab">
                    <i class="fas fa-road me-2"></i>Cadastrar Rodovias
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contractors-tab" data-bs-toggle="tab" data-bs-target="#contractors" type="button" role="tab">
                    <i class="fas fa-building me-2"></i>Empreiteiras
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inspectors-tab" data-bs-toggle="tab" data-bs-target="#inspectors" type="button" role="tab">
                    <i class="fas fa-user-tie me-2"></i>Fiscais
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                    <i class="fas fa-history me-2"></i>Histórico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="control-tab" data-bs-toggle="tab" data-bs-target="#control" type="button" role="tab">
                    <i class="fas fa-exclamation-circle me-2"></i>Controle
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="appTabContent">
            <!-- Registrar Vistoria -->
            <div class="tab-pane fade show active" id="register" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clipboard-check me-2"></i>Registrar Nova Vistoria
                    </div>
                    <div class="card-body">
                        <form id="inspectionForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="inspectorName" class="form-label required-field">Fiscal</label>
                                    <select class="form-select" id="inspectorName" required>
                                        <option value="" selected disabled>Selecione o fiscal</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="inspectionDate" class="form-label required-field">Data da Vistoria</label>
                                    <input type="date" class="form-control" id="inspectionDate" required>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="roadSelect" class="form-label required-field">Rodovia</label>
                                    <select class="form-select" id="roadSelect" required>
                                        <option value="" selected disabled>Selecione a rodovia</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="contractorInfo" class="form-label">Empreiteira Responsável</label>
                                    <div id="contractorInfo" class="form-control bg-light py-2">
                                        <span class="text-muted">Selecione a rodovia e o trecho</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="startKm" class="form-label required-field">KM Inicial</label>
                                    <input type="number" step="0.001" class="form-control" id="startKm" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="endKm" class="form-label required-field">KM Final</label>
                                    <input type="number" step="0.001" class="form-control" id="endKm" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="observations" class="form-label">Observações</label>
                                <textarea class="form-control" id="observations" rows="3" placeholder="Descreva as condições do trecho vistoriado..."></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <button type="button" id="addAnotherInspection" class="btn btn-outline-primary">
                                    <i class="fas fa-plus me-2"></i>Adicionar Outra Vistoria
                                </button>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Salvar Vistorias
                                </button>
                            </div>
                            
                            <div id="multipleInspectionsContainer" class="multiple-inspections-container d-none">
                                <h6 class="border-bottom pb-2 mb-3">Vistorias Adicionais</h6>
                                <div id="multipleInspectionsList">
                                    <!-- Vistorias adicionais serão adicionadas aqui -->
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-excel me-2"></i>Importar Vistorias via Planilha Excel
                    </div>
                    <div class="card-body">
                        <div class="excel-upload-area" id="excelUploadArea">
                            <div class="excel-upload-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <h5>Arraste e solte uma planilha Excel aqui</h5>
                            <p class="text-muted">ou clique para selecionar um arquivo</p>
                            <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display: none;">
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                A planilha deve conter as colunas: Data, Fiscal, Rodovia, KM Inicial, KM Final, Observações
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cadastrar Rodovias -->
            <div class="tab-pane fade" id="roads" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-road me-2"></i>Cadastrar Nova Rodovia
                    </div>
                    <div class="card-body">
                        <form id="roadForm">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="roadType" class="form-label required-field">Tipo</label>
                                    <select class="form-select" id="roadType" required>
                                        <option value="SP">SP</option>
                                        <option value="SPA">SPA</option>
                                        <option value="SPD">SPD</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="roadNumber" class="form-label required-field">Número</label>
                                    <input type="text" class="form-control" id="roadNumber" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="roadContractor" class="form-label">Empreiteira Padrão</label>
                                    <select class="form-select" id="roadContractor">
                                        <option value="">Nenhuma</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="roadStartKm" class="form-label required-field">KM Inicial</label>
                                    <input type="number" step="0.001" class="form-control" id="roadStartKm" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="roadEndKm" class="form-label required-field">KM Final</label>
                                    <input type="number" step="0.001" class="form-control" id="roadEndKm" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="roadDescription" class="form-label">Descrição</label>
                                <textarea class="form-control" id="roadDescription" rows="2" placeholder="Informações adicionais sobre a rodovia..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Cadastrar Rodovia
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>Trechos de Rodovias Cadastrados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="roadSectionsTable">
                                <thead>
                                    <tr>
                                        <th>Rodovia</th>
                                        <th>Trecho (KM)</th>
                                        <th>Extensão</th>
                                        <th>Empreiteira(s)</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cadastrar Empreiteiras -->
            <div class="tab-pane fade" id="contractors" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-building me-2"></i>Cadastrar Nova Empreiteira
                    </div>
                    <div class="card-body">
                        <form id="contractorForm">
                            <div class="mb-3">
                                <label for="contractorName" class="form-label required-field">Nome da Empreiteira</label>
                                <input type="text" class="form-control" id="contractorName" required placeholder="Nome da empresa">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Cadastrar Empreiteira
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>Empreiteiras Cadastradas
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="contractorsTable">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Trechos</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cadastrar Fiscais -->
            <div class="tab-pane fade" id="inspectors" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-user-tie me-2"></i>Cadastrar Novo Fiscal
                    </div>
                    <div class="card-body">
                        <form id="inspectorForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="inspectorFullName" class="form-label required-field">Nome Completo</label>
                                    <input type="text" class="form-control" id="inspectorFullName" required placeholder="Nome do fiscal">
                                </div>
                                <div class="col-md-6">
                                    <label for="inspectorRegistration" class="form-label required-field">Matrícula</label>
                                    <input type="text" class="form-control" id="inspectorRegistration" required placeholder="Número de matrícula">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="inspectorPhoto" class="form-label">Foto (opcional)</label>
                                <input type="file" class="form-control" id="inspectorPhoto" accept="image/*">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Cadastrar Fiscal
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>Fiscais Cadastrados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="inspectorsTable">
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>Nome</th>
                                        <th>Matrícula</th>
                                        <th>Vistorias</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Histórico -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>Histórico de Vistorias
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="filterInspector" class="form-label">Filtrar por Fiscal</label>
                                <select class="form-select" id="filterInspector">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filterRoad" class="form-label">Filtrar por Rodovia</label>
                                <select class="form-select" id="filterRoad">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filterDate" class="form-label">Filtrar por Data</label>
                                <input type="date" class="form-control" id="filterDate">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button id="exportExcel" class="btn btn-success me-2">
                                <i class="fas fa-file-excel me-2"></i>Exportar para Excel
                            </button>
                            <button id="exportPDF" class="btn btn-danger">
                                <i class="fas fa-file-pdf me-2"></i>Exportar para PDF
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="historyTable">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Fiscal</th>
                                        <th>Rodovia</th>
                                        <th>Trecho (KM)</th>
                                        <th>Empreiteira</th>
                                        <th>Georreferenciamento</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map-marked-alt me-2"></i>Importar Georreferenciamento via Planilha
                    </div>
                    <div class="card-body">
                        <div class="excel-upload-area" id="geoExcelUploadArea">
                            <div class="excel-upload-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <h5>Arraste e solte uma planilha Excel com dados de georreferenciamento</h5>
                            <p class="text-muted">ou clique para selecionar um arquivo</p>
                            <input type="file" id="geoExcelFileInput" accept=".xlsx, .xls" style="display: none;">
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                A planilha deve conter as colunas: Rodovia, KM, Latitude, Longitude
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controle -->
            <div class="tab-pane fade" id="control" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-exclamation-circle me-2"></i>Rodovias com Vistorias Atrasadas
                    </div>
                    <div class="card-body">
                        <ul class="control-list" id="overdueInspections">
                            <!-- Será preenchido via JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes da vistoria -->
    <div class="modal fade" id="inspectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Vistoria</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="inspectionDetails">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar georreferenciamento -->
    <div class="modal fade" id="geoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Georreferenciamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="geoForm">
                        <input type="hidden" id="geoInspectionId">
                        <div class="geo-input-group">
                            <label for="startLat" class="form-label">Latitude Inicial</label>
                            <input type="text" class="form-control" id="startLat" placeholder="Ex: -23.5505">
                        </div>
                        <div class="geo-input-group">
                            <label for="startLng" class="form-label">Longitude Inicial</label>
                            <input type="text" class="form-control" id="startLng" placeholder="Ex: -46.6333">
                        </div>
                        <div class="geo-input-group">
                            <label for="endLat" class="form-label">Latitude Final</label>
                            <input type="text" class="form-control" id="endLat" placeholder="Ex: -23.5505">
                        </div>
                        <div class="geo-input-group">
                            <label for="endLng" class="form-label">Longitude Final</label>
                            <input type="text" class="form-control" id="endLng" placeholder="Ex: -46.6333">
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary me-2" id="getCurrentLocationStart">
                                <i class="fas fa-location-arrow me-2"></i>Usar Minha Localização (Início)
                            </button>
                            <button type="button" class="btn btn-secondary" id="getCurrentLocationEnd">
                                <i class="fas fa-location-arrow me-2"></i>Usar Minha Localização (Fim)
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveGeo">Salvar Coordenadas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para gerenciar trechos de empreiteiras -->
    <div class="modal fade" id="sectionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gerenciar Trechos da Rodovia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>Trechos Cadastrados</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="roadSectionsModalTable">
                                <thead>
                                    <tr>
                                        <th>KM Inicial</th>
                                        <th>KM Final</th>
                                        <th>Empreiteira</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Preenchido via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Adicionar Novo Trecho</h6>
                    <form id="sectionForm">
                        <input type="hidden" id="modalRoadId">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="sectionStartKm" class="form-label">KM Inicial</label>
                                <input type="number" step="0.001" class="form-control" id="sectionStartKm" required>
                            </div>
                            <div class="col-md-3">
                                <label for="sectionEndKm" class="form-label">KM Final</label>
                                <input type="number" step="0.001" class="form-control" id="sectionEndKm" required>
                            </div>
                            <div class="col-md-4">
                                <label for="sectionContractor" class="form-label">Empreiteira</label>
                                <select class="form-select" id="sectionContractor" required>
                                    <option value="" selected disabled>Selecione</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmMessage">
                    <!-- Mensagem será preenchida via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funções para persistência de dados no localStorage
        function saveDataToLocalStorage() {
            localStorage.setItem('roadInspectors', JSON.stringify(inspectors));
            localStorage.setItem('roadContractors', JSON.stringify(contractors));
            localStorage.setItem('roadRoads', JSON.stringify(roads));
            localStorage.setItem('roadInspections', JSON.stringify(inspections));
        }

        function loadDataFromLocalStorage() {
            const savedInspectors = localStorage.getItem('roadInspectors');
            const savedContractors = localStorage.getItem('roadContractors');
            const savedRoads = localStorage.getItem('roadRoads');
            const savedInspections = localStorage.getItem('roadInspections');
            
            if (savedInspectors) inspectors = JSON.parse(savedInspectors);
            if (savedContractors) contractors = JSON.parse(savedContractors);
            if (savedRoads) roads = JSON.parse(savedRoads);
            if (savedInspections) inspections = JSON.parse(savedInspections);
        }

        // Dados iniciais (simulando um banco de dados)
        let inspectors = [
            { id: 1, name: 'João Silva', registration: 'FS001', photo: null },
            { id: 2, name: 'Maria Souza', registration: 'FS002', photo: null },
            { id: 3, name: 'Carlos Oliveira', registration: 'FS003', photo: null }
        ];

        let contractors = [
            { id: 1, name: 'Vanguarda' },
            { id: 2, name: 'Construcap' },
            { id: 3, name: 'Jon Engenharia' },
            { id: 4, name: 'Odebrecht' }
        ];

        let roads = [
            { 
                id: 1, 
                type: 'SP', 
                number: '270', 
                startKm: 0, 
                endKm: 720, 
                defaultContractorId: 1,
                description: 'Rodovia que liga São Paulo ao oeste do estado',
                sections: [
                    { id: 1, startKm: 0, endKm: 150, contractorId: 1 },
                    { id: 2, startKm: 150, endKm: 400, contractorId: 2 },
                    { id: 3, startKm: 400, endKm: 720, contractorId: 3 }
                ]
            },
            { 
                id: 2, 
                type: 'SP', 
                number: '330', 
                startKm: 0, 
                endKm: 320, 
                defaultContractorId: 4,
                description: 'Rodovia que liga Campinas a Mogi Mirim',
                sections: [
                    { id: 4, startKm: 0, endKm: 150, contractorId: 4 },
                    { id: 5, startKm: 150, endKm: 320, contractorId: 1 }
                ]
            }
        ];

        let inspections = [
            {
                id: 1,
                date: '2023-10-15',
                inspectorId: 1,
                roadId: 1,
                startKm: 50,
                endKm: 75,
                observations: 'Trecho em boas condições, sem problemas identificados.',
                geoStart: null,
                geoEnd: null
            },
            {
                id: 2,
                date: '2023-10-16',
                inspectorId: 2,
                roadId: 2,
                startKm: 100,
                endKm: 120,
                observations: 'Trecho com necessidade de manutenção no acostamento.',
                geoStart: null,
                geoEnd: null
            }
        ];

        // Carregar dados do localStorage se existirem
        loadDataFromLocalStorage();

        // Funções auxiliares
        function getRoadName(roadId) {
            const road = roads.find(r => r.id === roadId);
            return road ? `${road.type}-${road.number}` : 'N/A';
        }

        function getInspectorName(inspectorId) {
            const inspector = inspectors.find(i => i.id === inspectorId);
            return inspector ? inspector.name : 'N/A';
        }

        function getContractorName(contractorId) {
            const contractor = contractors.find(c => c.id === contractorId);
            return contractor ? contractor.name : 'N/A';
        }

        function getContractorForRoadSection(roadId, km) {
            const road = roads.find(r => r.id === roadId);
            if (!road) return null;
            
            const section = road.sections.find(s => s.startKm <= km && s.endKm >= km);
            return section ? section.contractorId : road.defaultContractorId;
        }

        function getRoadSections(roadId) {
            const road = roads.find(r => r.id === roadId);
            return road ? road.sections : [];
        }

        function addRoadSection(roadId, startKm, endKm, contractorId) {
            const road = roads.find(r => r.id === roadId);
            if (!road) return false;
            
            const newSection = {
                id: Math.max(...road.sections.map(s => s.id), 0) + 1,
                startKm: parseFloat(startKm),
                endKm: parseFloat(endKm),
                contractorId: parseInt(contractorId)
            };
            
            road.sections.push(newSection);
            saveDataToLocalStorage();
            return true;
        }

        // Função para remover um trecho de rodovia
        function removeRoadSection(roadId, sectionId) {
            const road = roads.find(r => r.id === roadId);
            if (!road) return false;
            
            const sectionIndex = road.sections.findIndex(s => s.id === sectionId);
            if (sectionIndex === -1) return false;
            
            road.sections.splice(sectionIndex, 1);
            saveDataToLocalStorage();
            return true;
        }

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar abas
            const triggerTabList = [].slice.call(document.querySelectorAll('#appTabs button'));
            triggerTabList.forEach(function (triggerEl) {
                new bootstrap.Tab(triggerEl);
            });
            
            // Preencher selects
            populateInspectors();
            populateContractors();
            populateRoads();
            
            // Preencher tabelas
            populateInspectorsTable();
            populateContractorsTable();
            populateRoadSectionsTable();
            populateHistoryTable();
            
            // Configurar eventos
            setupEventListeners();
        });

        // Preencher selects
        function populateInspectors() {
            const inspectorSelect = document.getElementById('inspectorName');
            const filterInspector = document.getElementById('filterInspector');
            
            inspectorSelect.innerHTML = '<option value="" selected disabled>Selecione o fiscal</option>';
            filterInspector.innerHTML = '<option value="">Todos</option>';
            
            inspectors.forEach(inspector => {
                inspectorSelect.innerHTML += `<option value="${inspector.id}">${inspector.name} (${inspector.registration})</option>`;
                filterInspector.innerHTML += `<option value="${inspector.id}">${inspector.name}</option>`;
            });
        }

        function populateContractors() {
            const roadContractor = document.getElementById('roadContractor');
            const sectionContractor = document.getElementById('sectionContractor');
            
            roadContractor.innerHTML = '<option value="">Nenhuma</option>';
            sectionContractor.innerHTML = '<option value="" selected disabled>Selecione</option>';
            
            contractors.forEach(contractor => {
                roadContractor.innerHTML += `<option value="${contractor.id}">${contractor.name}</option>`;
                sectionContractor.innerHTML += `<option value="${contractor.id}">${contractor.name}</option>`;
            });
        }

        function populateRoads() {
            const roadSelect = document.getElementById('roadSelect');
            const filterRoad = document.getElementById('filterRoad');
            
            roadSelect.innerHTML = '<option value="" selected disabled>Selecione a rodovia</option>';
            filterRoad.innerHTML = '<option value="">Todas</option>';
            
            roads.forEach(road => {
                roadSelect.innerHTML += `<option value="${road.id}">${road.type}-${road.number}</option>`;
                filterRoad.innerHTML += `<option value="${road.id}">${road.type}-${road.number}</option>`;
            });
        }

        // Preencher tabelas
        function populateInspectorsTable() {
            const tbody = document.querySelector('#inspectorsTable tbody');
            tbody.innerHTML = '';
            
            inspectors.forEach(inspector => {
                const inspectionCount = inspections.filter(i => i.inspectorId === inspector.id).length;
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            ${inspector.photo ? 
                                `<img src="${inspector.photo}" class="inspector-photo" alt="${inspector.name}">` : 
                                `<div class="inspector-photo bg-secondary d-flex align-items-center justify-content-center text-white">
                                    <i class="fas fa-user"></i>
                                </div>`
                            }
                        </td>
                        <td>${inspector.name}</td>
                        <td>${inspector.registration}</td>
                        <td><span class="badge bg-primary">${inspectionCount}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInspector(${inspector.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function populateContractorsTable() {
            const tbody = document.querySelector('#contractorsTable tbody');
            tbody.innerHTML = '';
            
            contractors.forEach(contractor => {
                // Contar quantos trechos cada empreiteira possui
                let sectionCount = 0;
                roads.forEach(road => {
                    sectionCount += road.sections.filter(s => s.contractorId === contractor.id).length;
                });
                
                tbody.innerHTML += `
                    <tr>
                        <td>${contractor.name}</td>
                        <td><span class="badge bg-primary">${sectionCount}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteContractor(${contractor.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function populateRoadSectionsTable() {
            const tbody = document.querySelector('#roadSectionsTable tbody');
            tbody.innerHTML = '';
            
            roads.forEach(road => {
                // Verificar se a rodovia tem trechos definidos
                if (road.sections && road.sections.length > 0) {
                    road.sections.forEach(section => {
                        const contractorName = getContractorName(section.contractorId);
                        const length = section.endKm - section.startKm;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${road.type}-${road.number}</td>
                                <td>${section.startKm.toFixed(3)} a ${section.endKm.toFixed(3)}</td>
                                <td>${length.toFixed(3)} km</td>
                                <td><span class="badge badge-contractor">${contractorName}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteSectionModal(${road.id}, ${section.id})">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    // Mostrar apenas a rodovia completa se não houver trechos definidos
                    const contractorName = getContractorName(road.defaultContractorId);
                    const length = road.endKm - road.startKm;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${road.type}-${road.number}</td>
                            <td>${road.startKm.toFixed(3)} a ${road.endKm.toFixed(3)}</td>
                            <td>${length.toFixed(3)} km</td>
                            <td><span class="badge badge-contractor">${contractorName}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" disabled>
                                    <i class="fas fa-info-circle"></i> Sem trechos
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
        }

        function populateHistoryTable() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            const filterInspector = document.getElementById('filterInspector').value;
            const filterRoad = document.getElementById('filterRoad').value;
            const filterDate = document.getElementById('filterDate').value;
            
            let filteredInspections = inspections;
            
            if (filterInspector) {
                filteredInspections = filteredInspections.filter(i => i.inspectorId == filterInspector);
            }
            
            if (filterRoad) {
                filteredInspections = filteredInspections.filter(i => i.roadId == filterRoad);
            }
            
            if (filterDate) {
                filteredInspections = filteredInspections.filter(i => i.date === filterDate);
            }
            
            filteredInspections.forEach(inspection => {
                const roadName = getRoadName(inspection.roadId);
                const inspectorName = getInspectorName(inspection.inspectorId);
                const contractorId = getContractorForRoadSection(inspection.roadId, (inspection.startKm + inspection.endKm) / 2);
                const contractorName = getContractorName(contractorId);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(inspection.date)}</td>
                        <td>${inspectorName}</td>
                        <td>${roadName}</td>
                        <td>${inspection.startKm.toFixed(3)} a ${inspection.endKm.toFixed(3)}</td>
                        <td>${contractorName}</td>
                        <td>
                            ${inspection.geoStart && inspection.geoEnd ? 
                                `<span class="badge bg-success geo-badge"><i class="fas fa-check-circle me-1"></i>Georreferenciado</span>` : 
                                `<button class="btn btn-sm btn-outline-primary" onclick="showGeoModal(${inspection.id})">
                                    <i class="fas fa-map-marker-alt me-1"></i>Adicionar
                                </button>`
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="showInspectionDetails(${inspection.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInspection(${inspection.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // Função para mostrar o modal de confirmação de exclusão de trecho
        function showDeleteSectionModal(roadId, sectionId) {
            const road = roads.find(r => r.id === roadId);
            if (!road) return;
            
            const section = road.sections.find(s => s.id === sectionId);
            if (!section) return;
            
            const contractorName = getContractorName(section.contractorId);
            
            document.getElementById('confirmMessage').innerHTML = `
                <p>Tem certeza que deseja excluir o trecho da rodovia ${road.type}-${road.number}?</p>
                <p><strong>KM:</strong> ${section.startKm.toFixed(3)} a ${section.endKm.toFixed(3)}</p>
                <p><strong>Empreiteira:</strong> ${contractorName}</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
            `;
            
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            confirmModal.show();
            
            document.getElementById('confirmAction').onclick = function() {
                if (removeRoadSection(roadId, sectionId)) {
                    populateRoadSectionsTable();
                    confirmModal.hide();
                    showAlert('Trecho excluído com sucesso!', 'success');
                } else {
                    showAlert('Erro ao excluir o trecho.', 'danger');
                }
            };
        }

        // Configurar eventos
        function setupEventListeners() {
            // Formulário de vistoria
            document.getElementById('inspectionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInspection();
            });
            
            // Formulário de rodovia
            document.getElementById('roadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveRoad();
            });
            
            // Formulário de empreiteira
            document.getElementById('contractorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveContractor();
            });
            
            // Formulário de fiscal
            document.getElementById('inspectorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInspector();
            });
            
            // Formulário de trecho
            document.getElementById('sectionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSection();
            });
            
            // Seleção de rodovia para mostrar empreiteira
            document.getElementById('roadSelect').addEventListener('change', function() {
                updateContractorInfo();
            });
            
            // Botão para adicionar outra vistoria
            document.getElementById('addAnotherInspection').addEventListener('click', function() {
                addAnotherInspection();
            });
            
            // Filtros do histórico
            document.getElementById('filterInspector').addEventListener('change', populateHistoryTable);
            document.getElementById('filterRoad').addEventListener('change', populateHistoryTable);
            document.getElementById('filterDate').addEventListener('change', populateHistoryTable);
            
            // Botões de exportação
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('exportPDF').addEventListener('click', exportToPDF);
            
            // Upload de Excel
            document.getElementById('excelUploadArea').addEventListener('click', function() {
                document.getElementById('excelFileInput').click();
            });
            
            document.getElementById('excelFileInput').addEventListener('change', handleExcelUpload);
            
            // Upload de Excel para georreferenciamento
            document.getElementById('geoExcelUploadArea').addEventListener('click', function() {
                document.getElementById('geoExcelFileInput').click();
            });
            
            document.getElementById('geoExcelFileInput').addEventListener('change', handleGeoExcelUpload);
            
            // Botões de geolocalização
            document.getElementById('getCurrentLocationStart').addEventListener('click', function() {
                getCurrentLocation('start');
            });
            
            document.getElementById('getCurrentLocationEnd').addEventListener('click', function() {
                getCurrentLocation('end');
            });
            
            // Salvar georreferenciamento
            document.getElementById('saveGeo').addEventListener('click', saveGeoData);
        }

        // Funções para salvar dados
        function saveInspection() {
            // Implementação existente
        }

        function saveRoad() {
            // Implementação existente
        }

        function saveContractor() {
            // Implementação existente
        }

        function saveInspector() {
            // Implementação existente
        }

        function saveSection() {
            // Implementação existente
        }

        // Funções auxiliares
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.app-header').after(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Funções para manipulação de dados
        function deleteInspector(id) {
            if (confirm('Tem certeza que deseja excluir este fiscal?')) {
                inspectors = inspectors.filter(i => i.id !== id);
                saveDataToLocalStorage();
                populateInspectors();
                populateInspectorsTable();
                showAlert('Fiscal excluído com sucesso!', 'success');
            }
        }

        function deleteContractor(id) {
            if (confirm('Tem certeza que deseja excluir esta empreiteira?')) {
                contractors = contractors.filter(c => c.id !== id);
                saveDataToLocalStorage();
                populateContractors();
                populateContractorsTable();
                showAlert('Empreiteira excluída com sucesso!', 'success');
            }
        }

        function deleteInspection(id) {
            if (confirm('Tem certeza que deseja excluir esta vistoria?')) {
                inspections = inspections.filter(i => i.id !== id);
                saveDataToLocalStorage();
                populateHistoryTable();
                showAlert('Vistoria excluída com sucesso!', 'success');
            }
        }

        // Outras funções (showInspectionDetails, showGeoModal, getCurrentLocation, saveGeoData, etc.)
        // ... (implementações existentes)

        // Funções de exportação
        function exportToExcel() {
            // Implementação existente
        }

        function exportToPDF() {
            // Implementação existente
        }

        // Upload de Excel
        function handleExcelUpload(event) {
            // Implementação existente
        }

        function handleGeoExcelUpload(event) {
            // Implementação existente
        }
    </script>
</body>
</html>